{% extends 'base.html' %}

{% block title %}Configurar Empty State - PMCELL{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Cabeçalho -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Configurar Imagem do Empty State</h1>
        <p class="text-gray-600 mt-2">Personalize a imagem exibida quando não houver pedidos ativos</p>
    </div>

    <!-- Preview da Imagem Atual -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Imagem Atual</h2>

        {% if config.empty_state_image %}
            <div class="flex items-center justify-center bg-gray-50 rounded-lg p-8">
                <img src="{{ config.empty_state_image.url }}"
                     alt="Empty State Atual"
                     class="max-w-md max-h-64 object-contain">
            </div>
            <p class="text-sm text-gray-600 mt-4 text-center">
                Imagem customizada ativa
            </p>
        {% else %}
            <div class="flex items-center justify-center bg-gray-50 rounded-lg p-8">
                <div class="text-center">
                    <svg class="mx-auto h-32 w-32 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="mt-4 text-gray-600">Usando imagem padrão do sistema</p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Formulário de Upload -->
    <div class="bg-white rounded-lg shadow-md p-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">Enviar Nova Imagem</h2>

        <form method="POST" enctype="multipart/form-data" id="upload-form">
            {% csrf_token %}

            <!-- Upload Area -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Selecione uma Imagem
                </label>

                <!-- Drag and Drop Area -->
                <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">Clique para selecionar ou arraste uma imagem</p>
                    <p class="mt-1 text-xs text-gray-500">{{ form.empty_state_image.help_text }}</p>
                </div>

                {{ form.empty_state_image }}

                {% if form.empty_state_image.errors %}
                    <div class="mt-2 text-sm text-red-600">
                        {% for error in form.empty_state_image.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Preview da Nova Imagem -->
                <div id="preview-container" class="hidden mt-4">
                    <p class="text-sm text-gray-700 mb-2">Preview:</p>
                    <div class="flex items-center justify-center bg-gray-50 rounded-lg p-4">
                        <img id="preview-image" class="max-w-sm max-h-48 object-contain">
                    </div>
                </div>
            </div>

            <!-- Erros gerais do formulário -->
            {% if form.non_field_errors %}
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                    {% for error in form.non_field_errors %}
                        <p class="text-sm text-red-600">{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Botões de Ação -->
            <div class="flex items-center justify-between gap-4">
                <div class="flex gap-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md">
                        Salvar Nova Imagem
                    </button>
                    <a href="{% url 'lista_usuarios' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md">
                        Voltar
                    </a>
                </div>

                {% if config.empty_state_image %}
                    <button type="button"
                            onclick="if(confirm('Tem certeza que deseja remover a imagem customizada e voltar para a imagem padrão?')) { document.getElementById('remove-form').submit(); }"
                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-md">
                        Restaurar Padrão
                    </button>
                {% endif %}
            </div>
        </form>

        <!-- Form oculto para remover imagem -->
        {% if config.empty_state_image %}
        <form id="remove-form" method="POST" class="hidden">
            {% csrf_token %}
            <!-- Empty form to trigger removal -->
        </form>
        {% endif %}
    </div>

    <!-- Informações Adicionais -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-sm font-semibold text-blue-800 mb-2">Informações sobre o Upload</h3>
        <ul class="text-sm text-blue-700 space-y-1">
            <li>• Formatos aceitos: JPG, PNG, WebP, SVG</li>
            <li>• Tamanho máximo: 2 MB</li>
            <li>• Dimensões mínimas: 400x400px (exceto SVG)</li>
            <li>• A imagem será otimizada automaticamente para melhor performance</li>
            <li>• Imagens raster serão convertidas para WebP e redimensionadas para 512x512px</li>
        </ul>
    </div>
</div>

<!-- JavaScript para Preview e Drag-and-Drop -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('pdf-file-input');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');

    // Click to select file
    dropZone.addEventListener('click', () => fileInput.click());

    // File input change
    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });

    // Drag and drop events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');

        const dt = e.dataTransfer;
        const files = dt.files;

        fileInput.files = files;
        handleFiles(files);
    });

    function handleFiles(files) {
        if (files.length > 0) {
            const file = files[0];

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewContainer.classList.remove('hidden');

                // Update drop zone text
                dropZone.querySelector('p').textContent = `Arquivo selecionado: ${file.name}`;
            };
            reader.readAsDataURL(file);
        }
    }
});
</script>
{% endblock %}
