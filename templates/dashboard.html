{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Sistema PMCELL{% endblock %}

{% block navbar_refresh_button %}
<button id="refresh-button"
        onclick="refreshDashboard()"
        class="hover:bg-blue-700 p-2 rounded transition-colors duration-300 relative"
        title="Atualizar dashboard">
    <svg id="refresh-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
    </svg>
    <!-- Spinner (hidden by default) -->
    <svg id="refresh-spinner" class="w-6 h-6 animate-spin hidden" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
</button>
{% endblock %}

{% block extra_head %}
<script src="{% static 'js/dashboard.js' %}" defer></script>
<script src="{% static 'js/cards.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">

    <!-- Lista de Pedidos -->
    <div class="mb-8">

        {% if pedidos %}
        <div id="pedidos-container" class="card-grid">
            {% for pedido in pedidos %}
            <a href="{% url 'pedido_detalhe' pedido.id %}" class="card-link">
                <div class="card-modern fade-in"
                     data-pedido-id="{{ pedido.id }}"
                     data-pedido-status="{{ pedido.status }}"
                     data-card-status="{{ pedido.card_status }}"
                     data-criado-em="{{ pedido.criado_em }}"
                     data-vendedor-id="{{ pedido.vendedor_id }}">

                    <!-- Borda superior colorida baseada no card_status -->
                    <div class="card-border-top card-border-{{ pedido.card_status_css }}"
                         data-card-border></div>

                    <div class="card-content">
                        <!-- Header: Número do orçamento e Badge de Status -->
                        <div class="card-header">
                            <span class="card-number">#{{ pedido.numero_orcamento }}</span>
                            <span class="status-badge-modern badge-{{ pedido.card_status_css }}"
                                data-status>
                                {{ pedido.card_status_display }}
                            </span>
                        </div>

                        <!-- Divisor -->
                        <div class="card-divider"></div>

                        <!-- Informações do Pedido -->
                        <div class="card-info">
                            <p class="card-info-primary">{{ pedido.cliente }}</p>
                            <p class="card-info-item">
                                <span class="card-info-label">Vendedor:</span>
                                <span class="card-info-value">{{ pedido.vendedor }}</span>
                            </p>
                            <p class="card-info-item">
                                <span class="card-info-label">Logística:</span>
                                <span class="card-info-value">{{ pedido.logistica }}</span>
                            </p>
                            <p class="card-info-item card-info-value">
                                {{ pedido.embalagem }}
                            </p>
                        </div>

                        <!-- Badges de Separadores -->
                        {% if pedido.separadores %}
                        <div class="separator-badges-container">
                            {% for separador in pedido.separadores %}
                            <span class="separator-badge">{{ separador }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Barra de Progresso -->
                        <div class="progress-container">
                            <div class="progress-wrapper">
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill"
                                         style="width: {{ pedido.porcentagem_separacao|default:0 }}%"
                                         data-progress="{{ pedido.porcentagem_separacao|default:0 }}"></div>
                                </div>
                                <span class="progress-text">
                                    {{ pedido.porcentagem_separacao|default:0 }}%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-lg p-6 text-center">
            {% if empty_state_image_url %}
                <img src="{{ empty_state_image_url }}"
                     alt="Nenhum pedido"
                     class="w-64 h-64 mx-auto mb-2 object-contain">
            {% else %}
                <img src="{% static 'images/empty-state.svg' %}"
                     alt="Nenhum pedido"
                     class="w-64 h-64 mx-auto mb-2">
            {% endif %}
            <h3 class="text-lg font-semibold text-gray-700 mb-2">
                {{ empty_state_titulo }}
            </h3>
            <p class="text-gray-500 mb-4">
                {{ empty_state_subtitulo }}
            </p>
            {% if usuario.tipo == 'VENDEDOR' or usuario.tipo == 'ADMINISTRADOR' %}
            <a href="{% url 'upload_pdf' %}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                + Criar Primeiro Pedido
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
